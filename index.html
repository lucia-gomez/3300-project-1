<html>
<!-- testing -->
<head>
  <script src="https://d3js.org/d3.v6.min.js"></script>
  <style>
    .gridlines line {
      stroke: lightgrey;
    }

    .gridlines .domain {
      stroke: none;
    }

    .titles {
      stroke: darkblue
    }

    svg {
      border: 1px solid black;
    }
  </style>
</head>

<body>

  <div>
  <p>Vacination Progress of Countries over Time</p>
  <p>Vacinations per Hundred vs. Time</p>
  <svg id="lineplot" width="800" height="500" style="border:2px solid grey; margin:20px;"></svg>

  <script>
    // Scales and Axises

    const svg = d3.select("svg#lineplot");
    const width = svg.attr("width");
    const height = svg.attr("height");
    const margin = {top: 20, right: 20, bottom: 50, left: 50};
    const chartWidth = width - margin.left - margin.right;
    const chartHeight = height - margin.top - margin.bottom;
    let chartArea = svg.append("g").attr("transform","translate("+margin.left+","+margin.top+")");

    d3.csv("country_vaccinations.csv", d3.autoType).then( (data) => {

      console.log("Country Vacination Data");
      console.log(data);

      const dateExtent = d3.extent(data, d => d.date);
      const dateScale = d3.scaleTime().domain(dateExtent).range([0, chartWidth]);

      // Hard Coded Vax per Hundred axis, will explain later
      // const vaxExtent = d3.extent(data, d => d['total_vaccinations_per_hundred']);
      const vaxScale = d3.scaleLinear().domain([0,40]).range([chartHeight, 0]);

      console.log(dateExtent);
      // console.log(vaxExtent);

      let vaxAxis = d3.axisLeft(vaxScale);
      let vaxGridlines = d3.axisLeft(vaxScale)
                  .tickSize(-chartWidth-15)
                  .tickFormat("");

      // add titles and axis labels
      svg.append("text").text('Time').attr('x', chartWidth/2).attr('y', chartHeight+60).attr('class', 'titles').attr('text-anchor', 'middle');

      svg.append("text").text('Vaccinations per one hundred people').attr('x', - chartHeight/2).attr('y', 10).attr('transform', 'rotate(-90)').attr('class', 'titles').attr('text-anchor', 'middle');

      svg.append("text").text('Vaccinations per one hundred people over time').attr('x', chartWidth/2).attr('y', 20).attr('class', 'titles').attr('text-anchor', 'middle');

      svg.append("text").text('United Kingdom').attr('x', 650).attr('y', 70).attr('text-anchor', 'middle').attr('stroke','orange');

      svg.append("text").text('United States').attr('x', 720).attr('y', 225).attr('text-anchor', 'middle').attr('stroke','blue');

      svg.append("text").text('Denmark').attr('x', 700).attr('y', 305).attr('text-anchor', 'middle').attr('stroke','red');

      svg.append("text").text('Italy').attr('x', 750).attr('y', 375).attr('text-anchor', 'middle').attr('stroke','green');

      let ticks = svg.append("g").attr("id","ticks");

      ticks.append("g")
          .attr("class", "yAxis")
          .attr("transform","translate("+(margin.left-15)+","+(margin.top+5)+")")
          .call(vaxAxis);

      ticks.append("g")
          .attr("class", "gridlines")
          .attr("transform","translate("+(margin.left-15)+","+(margin.top+5)+")")
          .call(vaxGridlines);

      let dateAxis = d3.axisBottom(dateScale)
                      .tickFormat(d3.timeFormat("%m/%d/%Y"));
      // Maybe pick a nicer format than this?
      let dateGridlines = d3.axisBottom(dateScale)
                  .tickSize(-chartHeight-5)
                  .tickFormat("");

      ticks.append("g")
        .attr("class", "xAxis")
        .attr("transform","translate("+margin.left+","+(chartHeight+margin.top+10)+")")
        .call(dateAxis);

      ticks.append("g")
          .attr("class", "gridlines")
          .attr("transform","translate("+margin.left+","+(chartHeight+margin.top+10)+")")
          .call(dateGridlines);

      // Create lines

      var pathGenerator = d3.line()
                            .x(d => dateScale(d['date']))
                            .y(d => vaxScale(d['total_vaccinations_per_hundred']))
                            .curve(d3.curveMonotoneX);

      const colors = d3.schemePaired;

      makeLine(data, pathGenerator, "United States", colors[0], colors[1], dateScale, vaxScale);
      makeLine(data, pathGenerator, "Italy", colors[2], colors[3], dateScale, vaxScale);
      makeLine(data, pathGenerator, "Denmark", colors[4], colors[5], dateScale, vaxScale);
      makeLine(data, pathGenerator, "United Kingdom", colors[6], colors[7], dateScale, vaxScale);

    });

    function makeLine(data, pathGenerator, country, linecolor, circlecolor, dateScale, vaxScale) {

      let countryData =  data.filter( (d) => {
        return d.country == country && d['total_vaccinations_per_hundred'] !== null; });

      chartArea.append("path").datum(countryData)
                      .attr("fill", "none")
                      .attr("stroke", linecolor)
                      .attr("stroke-width", 3)
                      .attr("d", pathGenerator);

      countryData.forEach( (d) => {

        let circle = chartArea.append("circle")
                .attr("r", 3)
                .attr("fill", circlecolor)
                .attr("cx", dateScale(d['date']) )
                .attr("cy", vaxScale(d['total_vaccinations_per_hundred']) );

      });

    }

  </script>

  </div>

  <p>Percent of vaccinated population </p>
  <svg id="per100" height=500 width=500></svg>

  <script>

    // a list of all the keys used in the GDP dataset
    // the dataset contains historical data for 1960-2020, but not all countries
    // have data for the most recent years
    const gdpYears = [];
    for (let i = 2020; i >= 1960; i--) {
      gdpYears.push(i);
    }

    const scatter = d3.select("svg#per100");

    const margins2 = { "top": 10, "right": 10, "bottom": 30, "left": 30 };
    const height2 = scatter.attr("height");
    const width2 = scatter.attr("width");

    const chartHeight2 = height2 - margins2.top - margins2.bottom;
    const chartWidth2 = width2 - margins2.left - margins2.right;

    let ticks = scatter.append("g").attr("id", "ticks2");
    let chartAreaScatter = scatter.append("g")
      .attr("id", "chartAreaScatter")
      .attr("transform", "translate(" + margins2.left + "," + margins2.top + ")");

    // load 2 files at once, and go to the .then function when they're both loaded
    Promise.all([
      d3.csv("country_vaccinations.csv"),
      d3.csv("country_gdp.csv")
    ]).then(files => {

      const vaxData = files[0];
      const gdpData = files[1];

      // clean vax data
      vaxData.forEach(d => {
        d.people_vaccinated_per_hundred = Number(d.people_vaccinated_per_hundred);
      });

      const countries = [... new Set(vaxData.map(d => d.country))];
      console.log("Number of countries", countries.length);

      const dates = d3.extent(vaxData, d => d.date);
      console.log("Oldest and most recent date", dates);

      // ignore countries that haven't been updated in a month
      const recentDates = vaxData.filter(d => d.date >= "2021-02-15");
      const countriesWithRecentDates = [... new Set(recentDates.map(d => d.country))];
      console.log("Number of countries with recent data", countriesWithRecentDates.length);

      // get most recent vax data for each country, since there's data for each day
      let recentData = countriesWithRecentDates.map(country => {
        const countryData = vaxData.filter(d => d.country === country);
        countryData.sort((a, b) => b.date.localeCompare(a.date));
        return countryData[0];
      });

      // -----------------------------------------

      // clean GDP data
      gdpData.forEach(d => {
        gdpYears.forEach(year => {
          d[year] = Number(d[year]);
        })
      });

      // -----------------------------------------

      // get most recent GDP data for each country
      // store in dict of COUNTRY CODE => GDP
      // allows for easy look-up later when iterating thru vax data
      // there might not be GDP data for every country in the vax dataset
      const recentGDP = {};
      gdpData.forEach(d => {
        for (let year of gdpYears) {
          if (d[year] !== 0) {
            recentGDP[d['Country Code']] = d[year];
            break;
          }
        }
      });

      // there are some extra rows in GDP data that represent aggregate data
      // we need to filter those out
      const validCountryToGDP = {};
      recentData.forEach(d => {
        if (d.iso_code in recentGDP) {
          validCountryToGDP[d.iso_code] = recentGDP[d.iso_code];
        }
      });

      // only include countries that have GDP data
      recentData = recentData.filter(d => d.iso_code in validCountryToGDP);

      // can't use d3.extent for GDP data since it's now stored in a dict/object
      const minGDP = Math.min(...Object.values(validCountryToGDP));
      const maxGDP = Math.max(...Object.values(validCountryToGDP));
      const gdpExtent = [minGDP, maxGDP];
      const gdpScale = d3.scaleLog().domain(gdpExtent).range([0, chartWidth2]);
      console.log(gdpExtent)

      const vaxPercentExtent = d3.extent(recentData, d => d.people_vaccinated_per_hundred);
      const vaxPercentScale = d3.scaleSymlog().domain(vaxPercentExtent).range([chartHeight2, 0]);

      const leftAxis = d3.axisLeft(vaxPercentScale);
      ticks.append("g")
        .attr("class", "y axis")
        .attr("transform", `translate(${margins2.left - 10}, ${margins2.top})`)
        .call(leftAxis);

      const horizontalGridlines = d3.axisLeft(vaxPercentScale)
        .tickSize(-chartWidth2 - 10)
        .tickFormat("");
      ticks.append("g")
        .attr("class", "y gridlines")
        .attr("transform", `translate(${margins2.left - 10}, ${margins2.top})`)
        .call(horizontalGridlines);

      const commaFormatter = d3.format(",");
      const bottomAxis = d3.axisBottom(gdpScale).ticks(4).tickFormat(d => "$" + commaFormatter(d));
      ticks.append("g")
        .attr("class", "x axis")
        .attr("transform", `translate(${margins2.left}, ${chartHeight2 + margins2.top + 10})`)
        .call(bottomAxis);

      const verticalGridlines = d3.axisBottom(gdpScale).ticks(4)
        .tickSize(-chartHeight2 - 10)
        .tickFormat("");
      ticks.append("g")
        .attr("class", "x gridlines")
        .attr("transform", `translate(${margins2.left}, ${chartHeight2 + margins2.top + 10})`)
        .call(verticalGridlines);

      recentData.forEach(d => {
        chartAreaScatter.append("circle")
          .attr("fill", "steelblue")
          .attr("r", 5)
          .attr("opacity", 0.8)
          .attr("cx", gdpScale(recentGDP[d.iso_code]))
          .attr("cy", vaxPercentScale(d.people_vaccinated_per_hundred))
          .attr("country", d.country)
          .attr("gdp", recentGDP[d.iso_code])
          .attr("vax", d.people_vaccinated_per_hundred)
      });

    })

  </script>
</body>

</html>
